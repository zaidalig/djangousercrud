<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User CRUD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4">User Management</h2>

  <!-- Add User Form -->
  <form id="addUserForm" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" class="form-control" placeholder="Username" name="username" required />
    </div>
    <div class="col-md-4">
      <input type="email" class="form-control" placeholder="Email" name="email" />
    </div>
    <div class="col-md-3">
      <input type="password" class="form-control" placeholder="Password" name="password" required />
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-success w-100">Add</button>
    </div>
  </form>

  <!-- Search -->
  <div class="mb-3">
    <input id="searchInput" class="form-control" placeholder="Search by username or emailâ€¦" />
  </div>

  <!-- User Table -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th><th>Username</th><th>Email</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="userTableBody"></tbody>
  </table>

  <!-- Pagination -->
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editUserForm">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" />
        <input type="text" class="form-control mb-2" name="username" placeholder="Username" required />
        <input type="email" class="form-control mb-2" name="email" placeholder="Email" />
        <input type="password" class="form-control" name="password" placeholder="New Password (optional)" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentPage = 1;
  let searchQuery = "";

  function loadUsers(page = 1, query = "") {
    fetch(`/api/users/?page=${page}&q=${query}`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("userTableBody");
        const pagination = document.getElementById("pagination");
        tbody.innerHTML = "";
        pagination.innerHTML = "";
        data.results.forEach(user => {
          tbody.innerHTML += `
            <tr>
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>${user.email || "-"}</td>
              <td>
                <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
              </td>
            </tr>`;
        });

        for (let i = 1; i <= data.total_pages; i++) {
          pagination.innerHTML += `
            <li class="page-item ${data.current_page === i ? 'active' : ''}">
              <a class="page-link" href="#" onclick="loadUsers(${i}, '${query}')">${i}</a>
            </li>`;
        }

        currentPage = data.current_page;
      });
  }

  document.getElementById("addUserForm").addEventListener("submit", e => {
    e.preventDefault();
    const form = e.target;
    const data = {
      username: form.username.value,
      email: form.email.value,
      password: form.password.value
    };
    fetch("/api/users/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    }).then(() => {
      form.reset();
      loadUsers(currentPage, searchQuery);
    });
  });

  function openEditModal(id) {
    fetch(`/api/users/${id}/`)
      .then(res => res.json())
      .then(user => {
        const form = document.getElementById("editUserForm");
        form.id.value = user.id;
        form.username.value = user.username;
        form.email.value = user.email;
        form.password.value = "";
        new bootstrap.Modal(document.getElementById("editModal")).show();
      });
  }

  document.getElementById("editUserForm").addEventListener("submit", e => {
    e.preventDefault();
    const form = e.target;
    const id = form.id.value;
    const data = {
      username: form.username.value,
      email: form.email.value,
      password: form.password.value
    };
    fetch(`/api/users/${id}/`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    }).then(() => {
      new bootstrap.Modal(document.getElementById("editModal")).hide();
      loadUsers(currentPage, searchQuery);
    });
  });

  function deleteUser(id) {
    if (confirm("Are you sure you want to delete this user?")) {
      fetch(`/api/users/${id}/`, { method: "DELETE" })
        .then(() => loadUsers(currentPage, searchQuery));
    }
  }

  document.getElementById("searchInput").addEventListener("input", e => {
    searchQuery = e.target.value;
    loadUsers(1, searchQuery);
  });

  loadUsers();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
